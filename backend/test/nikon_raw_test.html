<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Test page</title>
  </head>
  <body style="display:flex; flex-direction: row;">
    <div id="output" style="background-color: #aaa; width:50vw; display:flex; flex-direction: column;"></div>
    <div id="img_output" style="background-color: #aaa; width:50vw; display:flex; flex-direction: column;"></div>
    <script>
        const output = document.getElementById("output");
        const images = document.getElementById("img_output");
        const ws = new WebSocket("ws://localhost:9002");
        let blob_global;

        ws.onmessage = (e) => {
            console.log(e.data);
            try {
                rsp = JSON.parse(e.data);
                console.log(rsp);
                if(rsp.RequestType = "HalfSizePreview") {
                    if(typeof(rsp.RequestData.dataURL) == "string") {
                        let im = new Image();
                        im.src = rsp.RequestData.dataURL;
                        images.append(im);
                    }
                    else {
                        console.error("Failed to get image preview");
                    }
                    /*fetch(rsp.RequestData.dataURL)
                    .then(res => res.blob())
                    .then(blob_data => {
                        blob_global = blob_data;

                    });*/
                }
            }
            catch(SyntaxError) {
                let m = document.createElement("div");
                m.textContent = e.data;
                output.appendChild(m);
            }
        }

        ws.onopen = () => {
            req = {
                "RequestType": "HalfSizePreview",
                "RequestData": {
                    "filenames": [
                        "backslashtest\\nikon_targets_1.NEF",
                        "backslashtest\\nikon_targets_2.NEF",
                        "backslashtest\\nikon_white_1.NEF",
                        "backslashtest\\nikon_white_2.NEF",
                        "backslashtest\\nikon_dark_1.NEF",
                        "backslashtest\\nikon_dark_2.NEF"
                    ]
                }

                /*"RequestType": "processImg",
                "RequestData": {
                    "Images":[
                        {
                            "Art": "nikon_targets_1.NEF",
                            "White": "nikon_white_1.NEF",
                            "Dark": "nikon_dark_1.NEF"
                        },
                        {
                            "Art": "nikon_targets_2.NEF",
                            "White": "nikon_white_2.NEF",
                            "Dark": "nikon_dark_2.NEF"
                        }
                    ],
                    "TargetLocation":{
                        "TopLeft":{"x": 0, "y":0},
                        "TopRight": {"x":50, "y":0},
                        "BottomRight": {"x":50, "y":50},
                        "BottomLeft": {"x":0, "y":50},
                        "NumRows": 10,
                        "NumCols":10
                    }	
                        
                }*/
            };
            ws.send(JSON.stringify(req));
        };

        
    </script>
  </body>
</html>